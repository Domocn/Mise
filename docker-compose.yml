version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7
    container_name: mise-db
    restart: unless-stopped
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=mise
    networks:
      - mise-network

  # Ollama Local LLM (optional - for AI features without API)
  ollama:
    image: ollama/ollama:latest
    container_name: mise-ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    networks:
      - mise-network
    # Uncomment for GPU support (NVIDIA)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mise-backend
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - MONGO_URL=mongodb://mongodb:27017
      - DB_NAME=mise
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-key-change-me}
      - CORS_ORIGINS=*
      # LLM Configuration - choose one:
      # For local Ollama (no API key needed):
      - LLM_PROVIDER=ollama
      - OLLAMA_URL=http://ollama:11434
      - OLLAMA_MODEL=llama3
      # For OpenAI (requires API key):
      # - LLM_PROVIDER=openai
      # - EMERGENT_LLM_KEY=${OPENAI_API_KEY}
      # For Embedded AI (100% offline, no external service):
      # - LLM_PROVIDER=embedded
      # - EMBEDDED_MODEL=Phi-3-mini-4k-instruct.Q4_0.gguf
      - EMBEDDED_MODELS_PATH=/app/models
    volumes:
      - uploads_data:/app/uploads
      - models_data:/app/models
    depends_on:
      - mongodb
      - ollama
    networks:
      - mise-network

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: mise-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    environment:
      # Set this to your server's IP/hostname accessible from client browsers
      - REACT_APP_BACKEND_URL=${BACKEND_URL:-http://localhost:8001}
      - REACT_APP_OPENPANEL_URL=http://localhost:3002/api
      - REACT_APP_OPENPANEL_CLIENT_ID=00000000-0000-0000-0000-000000000000
    depends_on:
      - backend
    networks:
      - mise-network

  # OpenPanel Services
  op-db:
    profiles: ["analytics"]
    image: postgres:14-alpine
    restart: always
    volumes:
      - op-db-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    networks:
      - mise-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  op-kv:
    profiles: ["analytics"]
    image: redis:7.2.5-alpine
    restart: always
    volumes:
      - op-kv-data:/data
    command: ["redis-server", "--maxmemory-policy", "noeviction"]
    networks:
      - mise-network
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  op-ch:
    profiles: ["analytics"]
    image: clickhouse/clickhouse-server:24.3-alpine
    restart: always
    volumes:
      - op-ch-data:/var/lib/clickhouse
      - op-ch-logs:/var/log/clickhouse-server
      - ./docker/openpanel/clickhouse/clickhouse-config.xml:/etc/clickhouse-server/config.d/op-config.xml:ro
      - ./docker/openpanel/clickhouse/clickhouse-user-config.xml:/etc/clickhouse-server/users.d/op-user-config.xml:ro
      - ./docker/openpanel/clickhouse/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    environment:
      - CLICKHOUSE_SKIP_USER_SETUP=1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - mise-network
    healthcheck:
      test: ["CMD-SHELL", 'clickhouse-client --query "SELECT 1"']
      interval: 10s
      timeout: 5s
      retries: 5

  op-api:
    profiles: ["analytics"]
    image: lindesvard/openpanel-api:2.0.0
    restart: always
    command: >
      sh -c "
        echo 'Running migrations...'
        CI=true pnpm -r run migrate:deploy

        pnpm start
      "
    depends_on:
      op-db:
        condition: service_healthy
      op-ch:
        condition: service_healthy
      op-kv:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - VITE_SELF_HOSTED=true
      - REDIS_URL=redis://op-kv:6379
      - CLICKHOUSE_URL=http://default:password@op-ch:8123
      - DATABASE_URL=postgresql://postgres:postgres@op-db:5432/postgres?schema=public
      - DATABASE_URL_DIRECT=postgresql://postgres:postgres@op-db:5432/postgres?schema=public
      - DASHBOARD_URL=http://localhost:3001
      - API_URL=http://localhost:3002
      - COOKIE_SECRET=${COOKIE_SECRET:-your-secret-key-change-me}
      # Email settings (optional)
      - EMAIL_SENDER=${EMAIL_SENDER:-noreply@example.com}
      - RESEND_API_KEY=${RESEND_API_KEY:-re_123456789}
    ports:
      - "3002:3000"
    networks:
      - mise-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/healthcheck || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  op-dashboard:
    profiles: ["analytics"]
    image: lindesvard/openpanel-dashboard:2.0.0
    restart: always
    depends_on:
      op-api:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - VITE_SELF_HOSTED=true
      - API_URL=http://localhost:3002
    ports:
      - "3001:3000"
    networks:
      - mise-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/healthcheck || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  op-worker:
    profiles: ["analytics"]
    image: lindesvard/openpanel-worker:2.0.0
    restart: always
    depends_on:
      op-api:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - VITE_SELF_HOSTED=true
      - REDIS_URL=redis://op-kv:6379
      - CLICKHOUSE_URL=http://default:password@op-ch:8123
      - DATABASE_URL=postgresql://postgres:postgres@op-db:5432/postgres?schema=public
    networks:
      - mise-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/healthcheck || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mongodb_data:
  ollama_data:
  uploads_data:
  models_data:
  op-db-data:
  op-kv-data:
  op-ch-data:
  op-ch-logs:

networks:
  mise-network:
    driver: bridge
